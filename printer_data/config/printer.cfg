# This file contains common pin mappings for the BIGTREETECH Manta M8P V2.0
# To use this config, the firmware should be compiled for the
# STM32H723 with a "128KiB bootloader" "25 MHz crystal"
# and "USB (on PA11/PA12)", "CAN bus (on PD0/PD1)" or Serial (on USART1 PA10/PA9).

[include fluidd.cfg]
[include shell_command.cfg]

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_4B0026000751313339373836-if00
restart_method: command

[virtual_sdcard]
path: /home/pi/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 3000
max_z_velocity: 5
max_z_accel: 100

[skew_correction]

[stepper_x]
step_pin: PE6
dir_pin: !PE5
enable_pin: !PC14
microsteps: 16
rotation_distance: 40
endstop_pin: ^PF4
position_endstop: 0
position_max: 265
# position_min: 0
homing_speed: 50

[stepper_y]
step_pin: PE2
dir_pin: !PE1
enable_pin: !PE4
microsteps: 16
rotation_distance: 40
endstop_pin: ^PF3
position_endstop: 0
position_max: 230
# position_min: 0
homing_speed: 50

[stepper_z]
step_pin: PB4
dir_pin: !PB3
enable_pin: !PB6
microsteps: 16
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop
position_max: 250
position_min: -6

[safe_z_home]
home_xy_position: 164.00,121.70 # nozzle position is 114.90,110.80
speed: 150 
z_hop: 10
z_hop_speed: 10

# # Motor5
# [stepper_z1]
# step_pin: PG13
# dir_pin: PG12
# enable_pin: !PG15

[extruder]
step_pin: PG9
dir_pin: !PD7
enable_pin: !PG11 
microsteps: 16
rotation_distance: 7.77
full_steps_per_rotation: 200
nozzle_diameter: 0.400
filament_diameter: 1.75
max_extrude_only_distance: 100.0
heater_pin: PA0 # HE0
sensor_pin: PB0 # T0
sensor_type: ATC Semitec 104NT-4-R025H42G
#control: pid
#pid_Kp: 21.527
#pid_Ki: 1.063
#pid_Kd: 108.982
min_temp: 0
max_temp: 300
pressure_advance_smooth_time: 0.025
#min_extrude_temp: 0

[heater_fan heatbreak_cooling_fan]
pin: PF7
heater_temp: 50.0

[bltouch]
sensor_pin: PD13
control_pin: PD12
x_offset: -49.10
y_offset: -10.9
samples: 2
speed: 3

[bed_mesh]
speed: 150
horizontal_move_z: 5
## X = clearance from endstop
## Y = the point in front of the bed that gives clearence to the probe from clips
mesh_min: 12.40, 10.30
## X = max_X - probe_offset_X
## Y = (the point in the back of the bed that gives clearance to the nozzle from clips) - probe_offset_Y
mesh_max: 215.9, 209.40
probe_count: 17,17
mesh_pps: 1,1
algorithm: bicubic
bicubic_tension: 0.2
fade_start: 2
fade_end: 11
fade_target: 0

[screws_tilt_adjust]
screw1: 79.50, 35.75
screw1_name: front left screw
screw2: 249.55, 35.75
screw2_name: front right screw
screw3: 249.55, 206.10
screw3_name: rear right screw
screw4: 79.50, 206.10
screw4_name: rear left screw
horizontal_move_z: 5.0
speed: 200.0
screw_thread: CW-M4

[fan]
pin: PF9

[heater_bed]
heater_pin: PF5
sensor_pin: PB1 # TB
sensor_type: EPCOS 100K B57560G104F
#control: pid
#pid_Kp: 54.027
#pid_Ki: 0.770
#pid_Kd: 948.182
min_temp: 0
max_temp: 130

[gcode_macro SMARTHOME]
gcode:
    {% if printer.toolhead.homed_axes == "xyz" %}
        M118 Printer is already homed
    {% else %}
        M118 Printer needs homing...
        G28
    {% endif %}

[gcode_macro HOME_NOZZLE]
gcode:
  SMARTHOME
  G90
  G1 X114.90 Y110.80 F5000.00

[gcode_macro START_PRINT] 
gcode:
    {% set bed_temp = params.BED_TEMP|int %}
    {% set hotend_temp = params.HOTEND_TEMP|int %}
    M104 S150 # Start warming up hotend in the background
    M190 S{bed_temp} # Wait for bed to reach temperature

    BED_MESH_PROFILE LOAD=default
    SKEW_PROFILE LOAD=calilantern

    M104 S{hotend_temp} # Start heating up hotend in the background
    SMARTHOME # Home all axis
    M109 S{hotend_temp} # Wait for hotend to reach temperature

[gcode_macro END_PRINT] 
gcode:
    G91 # Relative positioning
    G1 E-2 F2700 # Retract a bit
    G1 E-2 Z0.2 F2400 # Retract and raise Z
    G1 X5 Y5 F3000 # Wipe out
    G1 Z10 # Raise Z more

    G90 # Absolute positioning
    G1 X0 Y230 # Present print
    M106 S0 # Turn-off fan
    M104 S0 # Turn-off hotend
    M140 S0 # Turn-off bed

    M84 X Y E # Disable all steppers but Z

    SET_SKEW CLEAR=1

[tmc2209 extruder]
uart_pin: PG10
run_current: 0.800
stealthchop_threshold: 999999

[tmc2209 stepper_x]
uart_pin: PC13
#diag_pin: PF4
run_current: 0.800
stealthchop_threshold: 999999

[tmc2209 stepper_y]
uart_pin: PE3
#diag_pin: PF3
run_current: 0.800
stealthchop_threshold: 999999

[tmc2209 stepper_z]
uart_pin: PB5
#diag_pin: PF1
run_current: 0.650
stealthchop_threshold: 999999

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.265000, -0.252500, -0.238750, -0.231250, -0.227500, -0.240000, -0.230000, -0.222500, -0.220000, -0.222500, -0.235000, -0.228750, -0.227500, -0.225000, -0.236250
#*# 	-0.225000, -0.220000, -0.210000, -0.203750, -0.207500, -0.222500, -0.215000, -0.212500, -0.213750, -0.222500, -0.232500, -0.228750, -0.230000, -0.228750, -0.240000
#*# 	-0.211250, -0.207500, -0.193750, -0.197500, -0.196250, -0.220000, -0.211250, -0.210000, -0.206250, -0.222500, -0.233750, -0.233750, -0.233750, -0.235000, -0.250000
#*# 	-0.181250, -0.180000, -0.182500, -0.181250, -0.187500, -0.203750, -0.205000, -0.203750, -0.211250, -0.225000, -0.246250, -0.242500, -0.241250, -0.245000, -0.261250
#*# 	-0.188750, -0.186250, -0.181250, -0.183750, -0.185000, -0.202500, -0.190000, -0.197500, -0.197500, -0.215000, -0.228750, -0.227500, -0.230000, -0.225000, -0.248750
#*# 	-0.192500, -0.193750, -0.190000, -0.186250, -0.186250, -0.203750, -0.195000, -0.197500, -0.200000, -0.207500, -0.226250, -0.226250, -0.222500, -0.225000, -0.231250
#*# 	-0.197500, -0.186250, -0.182500, -0.177500, -0.176250, -0.195000, -0.186250, -0.190000, -0.190000, -0.196250, -0.221250, -0.215000, -0.216250, -0.210000, -0.213750
#*# 	-0.186250, -0.182500, -0.175000, -0.172500, -0.175000, -0.195000, -0.187500, -0.191250, -0.191250, -0.201250, -0.217500, -0.213750, -0.215000, -0.200000, -0.218750
#*# 	-0.178750, -0.167500, -0.156250, -0.158750, -0.161250, -0.182500, -0.175000, -0.177500, -0.180000, -0.185000, -0.197500, -0.200000, -0.202500, -0.206250, -0.212500
#*# 	-0.193750, -0.187500, -0.177500, -0.173750, -0.173750, -0.188750, -0.183750, -0.185000, -0.185000, -0.193750, -0.210000, -0.205000, -0.208750, -0.206250, -0.215000
#*# 	-0.215000, -0.201250, -0.190000, -0.185000, -0.177500, -0.192500, -0.182500, -0.183750, -0.180000, -0.192500, -0.188750, -0.192500, -0.197500, -0.190000, -0.210000
#*# 	-0.200000, -0.193750, -0.187500, -0.178750, -0.173750, -0.185000, -0.181250, -0.176250, -0.163750, -0.178750, -0.187500, -0.188750, -0.183750, -0.185000, -0.191250
#*# 	-0.188750, -0.177500, -0.161250, -0.157500, -0.151250, -0.173750, -0.155000, -0.155000, -0.151250, -0.167500, -0.182500, -0.182500, -0.181250, -0.180000, -0.190000
#*# 	-0.197500, -0.192500, -0.185000, -0.173750, -0.166250, -0.185000, -0.177500, -0.183750, -0.180000, -0.190000, -0.195000, -0.205000, -0.200000, -0.208750, -0.218750
#*# 	-0.255000, -0.238750, -0.226250, -0.223750, -0.217500, -0.226250, -0.220000, -0.213750, -0.216250, -0.225000, -0.235000, -0.237500, -0.242500, -0.245000, -0.256250
#*# x_count = 15
#*# y_count = 15
#*# mesh_x_pps = 1
#*# mesh_y_pps = 1
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 12.4
#*# max_x = 215.82
#*# min_y = 10.3
#*# max_y = 209.38
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 33.756
#*# pid_ki = 4.413
#*# pid_kd = 64.558
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 75.004
#*# pid_ki = 1.976
#*# pid_kd = 711.599
#*#
#*# [bltouch]
#*# z_offset = 2.140
#*#
#*# [skew_correction calilantern]
#*# xy_skew = -0.002729444427103164
#*# xz_skew = 0.013138924211516792
#*# yz_skew = 0.0021354706570749786
